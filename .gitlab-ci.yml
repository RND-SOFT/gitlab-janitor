before_script:
    - mkdir -p ~/.docker
    - echo ${DOCKER_AUTH_CONFIG} > ~/.docker/config.json

stages:
  - build
  - tagging
  - deploy

variables:
  BUILDVERSION: ${CI_PIPELINE_ID}
  SERVICE_IMAGE: harbor.rnds.pro/rnds/gitlab-janitor
  SERVICE_TAG: ${CI_COMMIT_SHORT_SHA}
  CURRENT_TAG: ${CI_COMMIT_SHORT_SHA}

# MIXINS

include:
  - project: 'aggredator/support/composer'
    file: '/templates/tagging.yml'
  - project: 'aggredator/support/composer'
    file: '/templates/publish-readme-to-harbor.yml'


build:
  image: harbor.rnds.pro/dockerhub/rnds/gitlab-runner:latest
  stage: build
  script:
    - SERVICE_TAG=lastest docker-compose pull -q || true
    - export TAG=$(cat lib/gitlab_janitor/version.rb | grep -o -E '[0-9]+\.[0-9]+\.[0-9]+')
    - echo "TAG=${TAG} > version.env"
    - docker-compose build --force-rm --pull
    - docker-compose push
  artifacts:
    reports:
      dotenv: version.env   

# TAGGING STAGE

tagging:tags:
  extends: .tagging_tags
  variables:
    IMAGE: ${SERVICE_IMAGE}

tagging:branches:
  extends: .tagging_branches
  variables:
    IMAGE: ${SERVICE_IMAGE}

tagging:master:
  extends: .tagging_master  
  variables:
    IMAGE: ${SERVICE_IMAGE}

tagging:version:
  extends: .tagging
  before_script:
    - env
    - echo $TAG
    - cat version.env || true
  only:
    - master    



